set -e

WEBSERVER=
WEBBROWSER=

run_gemini_command() {

    local -r command_and_args="$@"

    trap "_cleanup" INT TERM EXIT

    _start_webserver; _start_webbrowser;

    local -r wd_ip=$(docker inspect --format '{{ .NetworkSettings.IPAddress }}' ${WEBBROWSER})

    node_modules/.bin/gemini $command_and_args --browsers-firefox-grid-url=http://$wd_ip:4444/wd/hub  visual-tests/

}


_cleanup() {

    testRes=$?
    trap - INT TERM EXIT
    docker rm -f ${WEBSERVER}  > /dev/null || true
    docker rm -f ${WEBBROWSER} > /dev/null || true

    exit ${testRes}
}


_start_webserver() {
    local -r IMAGE=***REMOVED***/dev-static-files/master:5

    if docker ps -a | grep -q data-for-jenkins-slave; then
        echo "BUILD SERVER BUILD"
        WEBSERVER=$(docker run --detach \
                               --env WWW_ROOT_FOLDER=${_ORIGINAL_WORKING_DIRECTORY_PATH} \
                               --volumes-from data-for-jenkins-slave \
                               ${IMAGE})
    else
        echo "LOCAL BUILD"
        WEBSERVER=$(docker run --detach \
                               --volume $(pwd):/var/www/static \
                               ${IMAGE})
    fi

}


_start_webbrowser() {

    WEBBROWSER=$(docker run --detach \
                            --link ${WEBSERVER}:***REMOVED*** \
                            selenium/standalone-firefox:2.52.0)
}
